/**
 * @fileoverview Firestore Security Rules for VideoKoleks application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model. Each user has full control over their data (videos and categories),
 * and no user can access another user's data.
 *
 * Data Structure:
 * Data is organized hierarchically under `/users/{userId}`, with subcollections for `videos` and `categories`.
 * - `/users/{userId}`: Stores user profiles. Access is restricted to the authenticated user.
 * - `/users/{userId}/videos/{videoId}`: Stores videos owned by the user.
 * - `/users/{userId}/categories/{categoryId}`: Stores categories created by the user.
 *
 * Key Security Decisions:
 * - User data is private; listing all users is disallowed.
 * - All authorization decisions are based on the authenticated user's UID (`request.auth.uid`).
 * - The rules avoid `get()` calls by relying on path-based ownership.
 *
 * Denormalization for Authorization:
 * - Each video and category document contains a `userId` field, which must match the `userId` in the path.
 *   This denormalization avoids the need to query a separate user document to verify ownership.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows users to read and write their own user document.
     * @path /users/{userId}
     * @allow (create) request.auth.uid == "{userId}"
     * @allow (get) request.auth.uid == "{userId}"
     * @allow (update) request.auth.uid == "{userId}"
     * @allow (delete) request.auth.uid == "{userId}"
     * @deny (create) request.auth.uid != "{userId}"
     * @deny (get) request.auth.uid != "{userId}"
     * @deny (update) request.auth.uid != "{userId}"
     * @deny (delete) request.auth.uid != "{userId}"
     * @principle Enforces document ownership and validates relational integrity.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if false; // User listing is disallowed.

      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Allows users to manage their own videos.
     * @path /users/{userId}/videos/{videoId}
     * @allow (create) request.auth.uid == "{userId}"
     * @allow (get) request.auth.uid == "{userId}"
     * @allow (update) request.auth.uid == "{userId}"
     * @allow (delete) request.auth.uid == "{userId}"
     * @deny (create) request.auth.uid != "{userId}"
     * @deny (get) request.auth.uid != "{userId}"
     * @deny (update) request.auth.uid != "{userId}"
     * @deny (delete) request.auth.uid != "{userId}"
     * @principle Enforces document ownership for writes and validates relational integrity.
     */
    match /users/{userId}/videos/{videoId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);

      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Allows users to manage their own categories.
     * @path /users/{userId}/categories/{categoryId}
     * @allow (create) request.auth.uid == "{userId}"
     * @allow (get) request.auth.uid == "{userId}"
     * @allow (update) request.auth.uid == "{userId}"
     * @allow (delete) request.auth.uid == "{userId}"
     * @deny (create) request.auth.uid != "{userId}"
     * @deny (get) request.auth.uid != "{userId}"
     * @deny (update) request.auth.uid != "{userId}"
     * @deny (delete) request.auth.uid != "{userId}"
     * @principle Enforces document ownership for writes and validates relational integrity.
     */
    match /users/{userId}/categories/{categoryId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);

      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }
  }
}